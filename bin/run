#!/bin/bash

echo "SSHのポートを指定してください。デフォルトのものから変更することが推奨されています。[default:22]"
read SSH_PORT
SSH_PORT_CHECK=`echo -n $SSH_PORT | sed 's/[0-9]//g'`

if [ -n "$SSH_PORT_CHECK" ]; then
    echo "SSHのポートは数字で指定してください。"
    exit 0
fi

echo $SSH_PORT "で指定されました。"

cat /etc/ssh/sshd_config | sed 's/Port 22/#Port 22\nPort <%= node['\''ssh'\'']['\''port'\''] %>/g' > /var/chef/cookbooks/ssh/templates/default/ssh.erb
echo "default['ssh']['port'] = '${SSH_PORT}'" >  /var/chef/cookbooks/ssh/attributes/default.rb

chef-solo -c /var/chef/config/solo.rb -j /var/chef/bin/runlist.json

